## 一、产品定位与总体目标

- **产品定位**: 面向独立开发者与像素美术的轻量级 2D 像素动画制作工具，重点是“像素级绘制 + 帧动画预览”，UI 基于 ImGui，运行在 SDL3 + OpenGL3 渲染之上。
- **核心目标**: 在保持界面与逻辑简单清晰的前提下，快速完成从“像素绘制 → 帧编辑 → 动画预览 → 导出资源（序列帧或图集）”的完整工作流。

---

## 二、功能需求表（按优先级与模块）

### 1. 项目与画布管理

- **新建项目**
  - 指定画布尺寸（宽、高，单位像素，如 16×16、32×32、64×64 等）。
  - 指定背景色（透明 / 实色）。
  - 默认创建一条动画（Animation）和一帧（Frame 0）。
- **项目属性**
  - 修改项目名称。
  - 修改默认 FPS 或每帧时长（ms）。
  - 修改画布尺寸（可选：是否支持后期缩放画布，MVP 可不做缩放，只支持新建时设置）。
- **多项目支持（后期）**
  - 可同时打开多个项目 Tab，或仅支持最近项目列表与快速切换。

### 2. 像素绘画核心功能（MVP 必做）

- **画布显示**
  - 像素级显示（无模糊），使用整数缩放（x1, x2, x4, x8...）。
  - 背景棋盘格显示透明区域。
  - 可开启/关闭像素网格线（例如在缩放>200%时显示）。
- **基础绘制工具**
  - **画笔工具**: 左键绘制当前颜色像素；支持点绘与拖动连续绘制（Bresenham 线插值）。
  - **橡皮擦工具**: 擦除为透明（或背景色）。
  - **直线工具（可选）**: 单击起点，拖动到终点绘制直线。
  - **矩形/填充矩形（可选）**: 绘制边框或填充矩形。
- **颜色选择**
  - HSV / RGB 调色面板。
  - 最近使用颜色列表（小色块）。
  - 颜色吸管：在画布上取色为当前颜色。
- **填充工具（油漆桶，优先级：中）**
  - 基于 4 邻域或 8 邻域的区域填充。
- **撤销 / 重做（优先级：高）**
  - 支持至少 20 步撤销 / 重做。
  - 基于命令栈或“像素增量”记录。

### 3. 帧动画编辑与播放

- **帧列表（时间线面板）**
  - 以缩略图或简化表示显示每一帧。
  - 添加帧：复制当前帧 / 新空白帧。
  - 删除帧：删除选中帧（带确认可选）。
  - 帧排序：拖拽调整帧顺序。
- **帧属性**
  - 每帧独立的持续时间（ms），也可使用全局 FPS。
  - 可标记关键帧（后期可扩展）。
- **动画播放控制**
  - 播放 / 暂停 / 停止。
  - 播放循环（默认循环）。
  - 当前帧指示（时间线与画布同步高亮）。
  - 播放速度调整（相对全局：0.5x, 1x, 2x）。
- **洋葱皮（Onion Skin，优先级：中）**
  - 显示前一帧与后一帧的半透明叠加。
  - 可配置显示多少帧（简单版：只显示前后各一帧）。

### 4. 图层系统（建议分阶段）

- **MVP**: 可先只做单图层（简化数据结构与绘制逻辑）。
- **进阶图层功能**
  - 多图层：背景层、角色层等。
  - 图层顺序调整。
  - 图层可见性开关。
  - 图层透明度（0–100%）。
  - 每一帧复用同一套图层结构（每帧每层一张图）。

### 5. 文件与资源管理

- **项目文件**
  - 自定义项目格式（如 `.pxanim`），内部用 JSON 或二进制，包含：
    - 画布尺寸、项目属性。
    - 动画列表、帧列表及每帧图像数据。
    - 图层数据（如果有）。
  - 支持新建 / 打开 / 另存为 / 最近项目列表。
- **导出功能（MVP 中的重要部分）**
  - 导出为序列 PNG（如 `anim_000.png`、`anim_001.png`...）。
  - 导出为 Sprite Sheet（精灵图集）：
    - 横向排布 / 网格排布。
    - 输出 PNG + JSON 描述（帧位置、尺寸、持续时间）。
- **后期扩展**
  - 导出 GIF（需要额外库，放在后期）。
  - 导出 APNG 或其他格式。

### 6. UI 与交互（ImGui）

- **主布局**
  - 顶部菜单栏：`File / Edit / View / Help` 等。
  - 左侧工具栏：画笔、橡皮擦、填充、吸管、直线、矩形等。
  - 中央画布区域：OpenGL 渲染的像素画布。
  - 右侧属性面板：颜色选择、工具属性（画笔大小等）。
  - 底部时间线（帧列表与播放控制）。
- **窗口与面板**
  - 可停靠 / 浮动的 ImGui Docking（后期）。
  - 状态栏：显示当前工具、坐标（x,y）、当前颜色、FPS。
- **交互与快捷键**
  - 常用快捷键：
    - `Ctrl+N/O/S`：新建/打开/保存项目。
    - `Ctrl+Z / Ctrl+Y`：撤销 / 重做。
    - `空格 + 拖拽`：平移画布（或中键拖拽）。
    - `鼠标滚轮 + Ctrl`：缩放画布。
  - 右键打开上下文菜单（可选）。

### 7. 非功能需求

- **性能**
  - 小尺寸（≤128×128）时，绘制延迟基本不可感知。
  - 播放常规帧数（如 100 帧以内）流畅无卡顿。
- **跨平台（优先级：次要）**
  - 主目标：Windows。
  - 保持 SDL3 + ImGui + OpenGL3 的跨平台特性，为以后移植留空间。
- **可扩展性**
  - 核心模块解耦（渲染、数据、UI、IO 独立），便于后续加入脚本、特效、插件等。

---

## 三、技术方案与模块设计

### 1. 技术栈与基础架构

- **底层框架**
  - SDL3：窗口创建、输入事件（键盘/鼠标）、定时器、平台抽象。
  - OpenGL3：纹理渲染、画布渲染、时间线缩略图渲染。
  - ImGui：UI 面板与控件，集成进 SDL + OpenGL 渲染管线。
- **语言与构建**
  - C++17 及以上。
  - CMake 管理工程，编译生成桌面应用。

### 2. 核心数据与模块

- **应用与主循环模块**
  - `App`:
    - 初始化 SDL、OpenGL、ImGui。
    - 主循环：处理事件 → 更新逻辑 → 渲染 → 延时控制。
- **渲染模块**
  - `Renderer`:
    - 管理 OpenGL 纹理对象。
    - 将像素缓冲区上传为纹理。
    - 根据缩放、平移在画布区域绘制。
- **像素画布模块**
  - `PixelCanvas`:
    - 内部维护 `std::vector<uint32_t>` RGBA 像素数组。
    - 提供 `SetPixel(x,y,color)`、`GetPixel(x,y)` 等接口。
    - 支持生成缩略图纹理供时间线使用。
- **工具系统**
  - `Tool` 抽象基类：`OnMouseDown/Move/Up()`。
  - 派生：`BrushTool`、`EraserTool`、`FillTool`、`LineTool` 等。
  - 工具与 `PixelCanvas` 和 `UndoStack` 协作完成绘制与撤销。
- **动画与时间线模块**
  - `Frame`:
    - 包含画布数据（或对像素缓冲引用）。
    - per-frame duration（ms）。
  - `Animation`:
    - `std::vector<Frame>`。
    - 播放状态（currentFrame, elapsedTime）。
  - `TimelineUI`:
    - 管理帧列表显示、选择、拖拽。
- **命令与撤销/重做模块**
  - `ICommand` 接口：`Execute()` / `Undo()`。
  - 常见命令：`DrawPixelsCommand`（记录一批像素的旧值与新值）。
  - `CommandStack`：两个栈管理 undo / redo。
- **项目与 IO 模块**
  - `Project`:
    - 基本属性（名称、画布大小、默认 FPS 等）。
    - 一个或多个 `Animation`。
  - `ProjectSerializer`:
    - 使用 JSON 库（如 nlohmann/json）进行序列化/反序列化。
    - PNG 序列导出、SpriteSheet 生成。

---

## 四、开发计划与阶段划分

下面给出一个按“从简到繁”的开发顺序（假设为 1 人开发，时间以人周为单位，可以按实际情况压缩/扩展）。

### 阶段 0：环境搭建与基础工程（约 0.5–1 周）

- **目标**
  - 搭建 CMake 工程，集成 SDL3、OpenGL3、ImGui。
- **任务**
  - 配置 CMakeLists，链接 SDL3 与 OpenGL。
  - 引入 ImGui 源码与 SDL3 + OpenGL3 后端。
  - 实现一个简单的窗口，显示 ImGui Demo 窗口。
- **验收标准**
  - 启动程序后出现窗口，ImGui Demo 可正常交互。

### 阶段 1：像素画布与基础绘图（约 1–2 周）

- **目标**
  - 完成单帧像素画布的绘制与基础编辑。
- **任务**
  - 实现 `PixelCanvas` 数据结构（RGBA 像素缓冲）。
  - 将像素缓冲上传为 OpenGL 纹理并在 ImGui 窗口中显示。
  - 实现画笔工具（左键拖动绘制）。
  - 实现橡皮擦工具。
  - 实现颜色选择器与当前颜色状态。
  - 实现缩放和平移（整数缩放 + 画布拖拽）。
  - 实现棋盘格背景与像素网格显示。
  - 初步 `Undo/Redo` 机制（针对单帧单图层）。
- **验收标准**
  - 用户可在单帧画布上用画笔和橡皮擦绘制像素，支持撤销重做，画布缩放与透明显示正常。

### 阶段 2：帧动画系统与时间线（约 1–2 周）

- **目标**
  - 支持多帧动画编辑、帧播放与时间线管理。
- **任务**
  - 定义 `Frame` 与 `Animation` 数据结构。
  - 时间线 UI：帧缩略图显示、当前帧高亮。
  - 添加/删除帧、复制帧、拖拽调整帧顺序。
  - 为每帧设置持续时间（默认继承全局 FPS，可单独修改）。
  - 播放控制（播放/暂停/停止、循环）。
  - 计时逻辑：根据 elapsed time 切换帧。
  - 洋葱皮基础实现（前一帧与后一帧淡色叠加）。
- **验收标准**
  - 用户可创建多帧动画，预览播放流畅，时间线操作稳定。

### 阶段 3：项目系统与导入导出（约 1–1.5 周）

- **目标**
  - 可以保存/加载项目文件，并导出游戏可用资源。
- **任务**
  - 定义 `Project` 数据模型。
  - 使用 JSON 库实现项目序列化/反序列化（包含全部帧像素数据）。
  - `File` 菜单：新建、打开、保存、另存为、最近项目列表。
  - PNG 序列导出：将每帧画布导出为 PNG。
  - SpriteSheet 导出：横向或网格排布，生成 PNG + JSON 描述。
- **验收标准**
  - 用户可保存项目、关闭应用后重新打开项目继续编辑。
  - PNG 序列与图集导出成功，可被外部引擎（如 Unity/自研引擎）读取。

### 阶段 4：扩展与打磨（约 1–2 周，可迭代）

- **目标**
  - 提升生产力与体验，增强稳定性。
- **建议功能**
  - 完整快捷键系统（可配置性后置）。
  - 更多绘图工具（直线、矩形、填充）。
  - 更稳定与高效的撤销/重做（合并小操作为大命令）。
  - 多图层支持（如：背景层、角色层）。
  - 改进 UI 布局（ImGui Docking，用户可自定义面板布局）。
- **非功能优化**
  - 性能 Profiling 与优化（减少纹理上传频率、减少 UI 重绘开销、避免在播放时全量拷贝像素数据）。
  - 稳定性：异常处理、文件损坏提示、导出失败提示、边界条件修复。
  - 可用性：默认快捷键提示、工具提示（tooltip）、更好的配色与布局。
- **验收标准**
  - 常用工作流（新建→绘制→加帧→播放→导出）在 30 分钟内不崩溃、不出现明显卡顿或数据丢失。
  - 常用快捷键与面板布局符合直觉，新用户可自学完成基本操作。

---

## 五、MVP 交付范围（强约束）

为确保能尽快可用，建议将 MVP 明确锁定为以下范围（其余进入后续迭代）：

- **必须有**
  - 单项目（一次只打开一个项目也可）、单动画、单图层。
  - 基础工具：画笔、橡皮擦、吸管（填充可推迟到 MVP+）。
  - 画布交互：缩放（整数倍）、平移、棋盘格透明背景、可选网格线。
  - 撤销/重做（至少 20 步）。
  - 帧时间线：添加/复制/删除/排序、缩略图、选帧绘制。
  - 播放控制：播放/暂停/停止、循环、全局 FPS（逐帧时长可延后）。
  - 保存/打开项目；导出序列 PNG；导出 SpriteSheet（PNG+JSON）。
- **明确不做（放到迭代）**
  - 多项目同时打开、完整图层系统、GIF/APNG 导出、复杂选区/变换、画笔形状/抖动/滤镜等。

---

## 六、验收清单（可直接用作测试用例）

### 1. 绘制与画布
- 画布显示清晰无模糊（Nearest 采样），缩放 x1/x2/x4/x8 正常。
- 左键拖动连续绘制无断点（线段插值正确），快速划线也能连贯。
- 橡皮擦将像素设为透明（或背景色，需在文档中二选一并保持一致）。
- 吸管能准确读取鼠标所在像素颜色（含透明的处理规则：透明则取 RGBA(0,0,0,0) 或忽略，需明确）。
- 棋盘格背景正确显示透明区域，导出 PNG 透明通道正确。
- 网格线开关正常，缩放很小时可自动隐藏或变淡。

### 2. 撤销/重做
- 单次笔画作为一个撤销单元（按下到抬起）。
- 连续撤销/重做不会导致像素错乱或崩溃。
- 新操作发生后 redo 栈清空。

### 3. 帧与播放
- 新增空白帧/复制帧成功，帧缩略图与实际内容一致。
- 删除帧不会导致当前帧索引越界。
- 拖拽排序后播放顺序与时间线一致。
- 播放时当前帧高亮会跟随变化；暂停后停留在当前帧。
- 循环播放在最后一帧后回到第一帧。

### 4. 文件与导出
- 保存后关闭再打开，内容完全一致（像素、帧顺序、FPS、背景设置等）。
- 导出序列 PNG 数量与帧数一致、命名正确、透明通道正确。
- 导出 SpriteSheet：图集尺寸计算正确，JSON 中每帧 `x,y,w,h` 与图集一致。
- 对非法路径/无权限目录有提示，不会静默失败。

---

## 七、数据格式设计（建议草案）

### 1. 项目文件 `.pxanim`（建议 JSON + 可选压缩）

建议先做 **JSON 明文**（便于调试），后期可加 zip/deflate 压缩。

- **顶层字段**
  - `version`: number（例如 1）
  - `projectName`: string
  - `canvas`: `{ width:number, height:number }`
  - `bg`: `{ type:"transparent"|"solid", colorRGBA?:[r,g,b,a] }`
  - `defaultFps`: number
  - `animations`: `Animation[]`

- **Animation**
  - `name`: string
  - `loop`: boolean
  - `frames`: `Frame[]`

- **Frame**
  - `durationMs`: number（如果用全局 FPS，可写 -1 或省略，读取时回退到全局）
  - `layers`: `Layer[]`（MVP 单图层时可固定为 1）

- **Layer**
  - `name`: string
  - `visible`: boolean
  - `opacity`: number（0..1）
  - `pixels`: string（像素数据；建议 base64 编码的 RGBA8888 原始字节流）

**像素编码建议（RGBA8888）**：
- 每像素 4 字节，顺序 `R,G,B,A`。
- `pixels` 字段存 `base64(rawBytes)`，长度为 `width*height*4`。
- 读取时严格校验长度，不符合则提示“文件损坏或版本不兼容”。

### 2. SpriteSheet 导出 JSON（建议）

- `meta`:
  - `image`: string（png 文件名）
  - `size`: `{ w:number, h:number }`
  - `frameSize`: `{ w:number, h:number }`
  - `fps`: number
- `frames`: array
  - 每项：`{ index:number, x:number, y:number, w:number, h:number, durationMs:number }`

---

## 八、目录结构与代码模块建议（贴合 CMake 工程）

建议在现有 `src/` 下逐步形成清晰边界（命名仅供参考）：

- `src/app/`
  - `App.h/.cpp`（生命周期、主循环）
- `src/render/`
  - `GLRenderer.h/.cpp`（纹理上传、画布渲染、缩略图渲染）
  - `Shaders/`（如需要）
- `src/core/`
  - `Project.h/.cpp`
  - `Animation.h/.cpp`, `Frame.h/.cpp`, `Layer.h/.cpp`
  - `PixelCanvas.h/.cpp`
- `src/tools/`
  - `Tool.h`（接口）
  - `BrushTool.*`, `EraserTool.*`, `EyedropperTool.*`, `FillTool.*`（迭代加入）
- `src/undo/`
  - `ICommand.h`
  - `CommandStack.*`
  - `DrawPixelsCommand.*`
- `src/io/`
  - `ProjectSerializer.*`
  - `PngIO.*`（读写 PNG：建议用 stb_image_write / lodepng / libpng 三选一）
  - `SpriteSheetExporter.*`
- `src/ui/`
  - `MainMenuBar.*`
  - `CanvasPanel.*`
  - `ToolPanel.*`
  - `TimelinePanel.*`
  - `ProjectPanel.*`
- `src/menu/`、`src/commands/`、`src/windows/`
  - 如果你已在用命令/窗口体系，建议逐步与上述模块对齐，避免重复抽象。

---

## 九、关键实现要点（落地细节）

### 1. 坐标系统与命中测试（容易出 bug）
- 画布像素坐标 \((px,py)\) 与屏幕坐标 \((sx,sy)\) 必须有唯一映射：
  - `canvasOriginScreen`：画布左上角在屏幕/ImGui窗口中的位置
  - `zoom`：整数缩放倍率
  - `pan`：平移偏移（以屏幕像素或画布像素为单位需统一）
- 命中像素计算（示例逻辑）：
  - `local = mouseScreen - canvasOriginScreen - panScreen`
  - `px = floor(local.x / zoom)`
  - `py = floor(local.y / zoom)`
  - 边界：`0<=px<w && 0<=py<h`

### 2. 纹理更新策略（性能关键）
- 朴素做法：每次像素改动就 `glTexSubImage2D` 全量上传（MVP 可接受小画布）。
- 优化做法（迭代）：
  - 记录脏矩形（dirty rect），仅上传改动区域。
  - 一次笔画结束后再批量上传（绘制过程中可以低频上传，例如每 16ms）。

### 3. 连续绘制（防断线）
- 鼠标 move 事件离散，必须在上次像素坐标与当前像素坐标之间补点：
  - 使用 Bresenham 画线算法，把所有中间像素加入“本次笔画像素集合”。

### 4. Undo/Redo 的像素差分记录（推荐）
- 一次笔画（mouse down → up）生成一个 `DrawPixelsCommand`：
  - 记录所有改动点的 `(x,y, oldRGBA, newRGBA)`
  - 执行：写入 new；撤销：写回 old
- 注意去重：同一笔画里同一像素可能被多次覆盖，建议只记录首次 old 与最终 new。

### 5. 填充工具（Flood Fill，迭代）
- 使用队列 BFS，避免递归栈溢出。
- 4 邻域更符合像素风常见预期（8 邻域可作为选项）。
- 需要明确“目标颜色相等”的定义：
  - MVP 采用 RGBA 完全相等；后期可加容差。

### 6. 播放计时（帧时长 vs FPS）
- 若只做全局 FPS：每帧时长 `frameMs = 1000 / fps`。
- 若支持逐帧时长：对每帧累加 `elapsedMs`，超过该帧 duration 就切到下一帧并减去溢出。

---

## 十、测试计划（分层）

### 1. 单元测试（可选，但很值）
- 适合单测的模块：
  - Bresenham 线插值输出点集是否正确。
  - Flood fill 是否正确、是否越界。
  - 序列化/反序列化后数据一致性（像素校验 hash）。
  - SpriteSheet 布局计算（图集尺寸、帧坐标）。

### 2. 手动回归测试（每个里程碑必做）
- 按“验收清单”逐条走一遍。
- 附加压力用例：
  - 画布 128×128，100 帧，持续涂抹 5 分钟。
  - 快速切帧 + 播放 + 继续绘制。
  - 保存/打开循环 20 次，确保不损坏数据。

---

## 十一、风险与对策

- **风险：坐标映射与输入处理混乱，导致绘制偏移/缩放错误**
  - 对策：把“屏幕→画布像素”转换封装成一个函数，所有工具统一调用；加可视化调试（显示当前 px,py）。
- **风险：撤销记录过大导致内存爆**
  - 对策：限制 undo 步数；命令内像素差分去重；必要时对命令做压缩（例如 RLE 或块存储）。
- **风险：频繁纹理上传导致卡顿**
  - 对策：先保证 MVP；再做 dirty rect 与低频上传；播放时避免无意义上传。
- **风险：项目文件格式迭代后不兼容**
  - 对策：加入 `version` 字段；读取时做兼容分支或给出升级提示。

---

## 十二、里程碑与交付物（建议）

- **M0（阶段0结束）**：可运行的 SDL3+ImGui+OpenGL3 空壳工程。
- **M1（阶段1结束）**：单帧像素绘制工具可用（含撤销/重做、缩放平移、透明棋盘格）。
- **M2（阶段2结束）**：多帧编辑+播放可用（时间线、缩略图、循环播放、洋葱皮基础）。
- **M3（阶段3结束）**：可保存/加载项目，导出序列 PNG 与 SpriteSheet（PNG+JSON）。
- **M4（阶段4迭代）**：体验与稳定性打磨 + 额外工具/图层（按优先级逐步加）。

---

## 十三、UI 面板原型与交互细则

本节目标：把“界面长什么样、点哪里能做什么”写清楚，方便后续对照实现。

### 1. 顶部菜单栏

- **File 菜单**
  - **New Project... (`Ctrl+N`)**
    - 弹出模态对话框：输入项目名、画布宽高、背景类型（透明/纯色）、默认 FPS。
    - 点击“Create”后清空当前项目数据，创建新项目并重置时间线到 Frame 0。
  - **Open Project... (`Ctrl+O`)**
    - 弹出系统文件选择器或自定义文件浏览对话框，过滤扩展名 `.pxanim`。
    - 读取失败时弹错误弹窗（不要静默失败）。
  - **Save (`Ctrl+S`)**
    - 若项目已有路径：直接保存。
    - 若无路径（首次保存）：等价于 “Save As...”。
  - **Save As...**
    - 弹保存对话框，让用户选择路径与文件名（默认使用项目名）。
  - **Recent Projects**
    - 子菜单列出最近 N 个项目，点击自动打开。
  - **Exit**
    - 如当前有未保存修改则弹出 “Save / Don’t Save / Cancel” 对话框。

- **Edit 菜单**
  - **Undo (`Ctrl+Z`)**：调用 `CommandStack::Undo`。
  - **Redo (`Ctrl+Y`)**：调用 `CommandStack::Redo`。
  - **Cut/Copy/Paste（可留空或灰掉，后期做选区功能时再启用）**。

- **View 菜单**
  - 勾选/取消各面板：
    - `Show Tool Panel`
    - `Show Timeline`
    - `Show Status Bar`
    - `Show Onion Skin`
  - 视图缩放：
    - `Zoom 1x / 2x / 4x / 8x`（单选）。

- **Help 菜单**
  - `About`：显示版本号、作者信息、依赖库致谢。
  - （可选）`Shortcuts`：显示常用快捷键速查表。

### 2. 左侧工具栏（Tool Panel）

- **展示内容**
  - 工具按钮垂直排列，每个按钮有图标+提示文字（通过 ImGui Tooltip）。
  - 顺序建议：
    - Brush（画笔）
    - Eraser（橡皮擦）
    - Eyedropper（吸管）
    - Fill（油漆桶，MVP+）
    - Line（直线工具，MVP+）
    - Rect / Filled Rect（矩形/填充矩形，MVP+）
- **交互规则**
  - 点击按钮切换当前工具，当前选中高亮。
  - 鼠标悬停显示提示气泡：名称 + 快捷键（如 `B` 代表 Brush）。
  - 工具的参数（如画笔半径）在右侧属性面板中调整，不在此面板内。

### 3. 中央画布区域（Canvas Panel）

- **展示内容**
  - 背景为棋盘格纹理。
  - 在棋盘格上按照当前 `zoom` 缩放绘制像素纹理。
  - 可选叠加网格线（灰色 1 像素线），支持开关。
  - 若开启洋葱皮：当前帧下方/上方再分别绘制前后帧的半透明版本（颜色或透明度略淡）。
- **交互行为**
  - **左键（根据当前工具）**
    - Brush：按下开始一笔，移动时连续绘制，抬起结束一笔（创建一个 Command）。
    - Eraser：同 Brush，但像素变为透明/背景色。
    - Eyedropper：单击拾取所指像素颜色，更新当前前景色，不改变画布。
    - Fill：在点击像素处执行区域填充（MVP+）。
    - Line/Rect：按下记录起点，移动显示预览，抬起实绘（MVP+）。
  - **中键拖拽 或 `Space`+左键拖拽**
    - 平移画布视图（改变 pan 偏移，不改像素数据）。
  - **滚轮 + Ctrl**
    - 以鼠标所在位置为中心缩放画布（zoom 在 {1,2,4,8,...} 间跳变）。
  - **状态栏反馈**
    - 鼠标在画布上时：在状态栏显示当前像素坐标 `(x,y)` 与像素颜色。
    - 鼠标在画布外时：显示 `--` 或空。

### 4. 右侧属性面板（Properties / Inspector）

- **当前工具属性**
  - Brush：画笔大小（1/2/3 像素）、硬度（先留空）、是否抗锯齿（像素画一般关闭）。
  - Eraser：大小（1/2/3 像素）。
  - 其他工具：根据需要增加参数（如线型、矩形是否填充）。
- **颜色选择器**
  - 当前前景色大色块。
  - HSV/RGB 颜色拾取器。
  - 最近颜色条（8~16 个历史颜色格子，点击恢复）。
- **帧/动画属性（可选择放在此面板下方）**
  - 当前动画名、是否循环。
  - 当前帧持续时间（ms），若使用全局 FPS，可显示为只读或显示“继承全局设置”。

### 5. 底部时间线（Timeline Panel）

- **展示内容**
  - 横向排列的帧缩略图（固定宽度，高度较小）。
  - 当前选中帧高亮边框。
  - 播放控制按钮：Play/Pause、Stop、Loop 开关、全局 FPS 输入框/滑条。
- **交互行为**
  - 点击帧缩略图：切换当前编辑帧。
  - 拖拽缩略图：改变帧顺序（拖放后更新 Animation 内部帧顺序）。
  - 右键帧弹出菜单：
    - Duplicate Frame
    - Insert Empty Frame Before/After
    - Delete Frame
  - 播放按钮：
    - Play：设置播放状态为 true，从当前帧开始按 FPS 播放。
    - Pause：停止时间推进，保持当前帧。
    - Stop：回到帧 0 并暂停。

### 6. 状态栏（Status Bar）

- **显示信息**
  - 左侧：当前项目名（含 * 标记未保存状态）。
  - 中间：当前工具名称 + 像素坐标 `(x,y)` + 当前颜色十六进制 `#RRGGBBAA`。
  - 右侧：渲染 FPS / 逻辑 FPS。

---

## 十四、开发任务分解与现有工程结构映射

本节将上述需求映射到你当前工程（如 `src/main.cpp`、`src/menu/`、`src/commands/`、`src/windows/`）的典型结构上，方便一步步落地。

### 1. main.cpp 层（程序入口与主循环）

- **职责**
  - 初始化 SDL3、OpenGL3、ImGui。
  - 构造 `App` 或类似的应用对象。
  - 运行主循环（事件分发 → 更新 → 渲染）。
  - 程序退出时释放资源。
- **推荐任务**
  - 封装一个 `Application` 或 `AppContext` 结构体，持有：
    - 当前 `Project` 指针或实例。
    - 渲染器实例（如 `GLRenderer`）。
    - UI 状态（哪些窗口显示、当前选中工具、当前帧索引等）。
  - 在主循环中：
    - 从 SDL 轮询输入事件，转换为 ImGui 事件。
    - 调用一组 UI 绘制函数：`DrawMainMenu()`, `DrawToolPanel()`, `DrawCanvasPanel()`, `DrawTimelinePanel()` 等。

### 2. menu 系统（菜单项与命令）

#### 2.1 `src/menu/menu_items/Menu_File.*`

- **当前文件用途**：预计用于构建 “File” 菜单。
- **具体任务**
  - 在 `Menu_File` 中实现：
    - `New Project`, `Open`, `Save`, `Save As`, `Exit` 菜单项。
  - 每个菜单项不直接操作底层，而是：
    - 构造并触发对应 command（如 `cmd_New_Project`）。
    - 或调用高层接口（如 `AppContext::NewProject()`）。

#### 2.2 其他菜单（Edit / View / Help）

- 建议新增对应 `Menu_Edit.*`、`Menu_View.*`、`Menu_Help.*` 或统一在一个 `MainMenuBar.*` 中实现，内部再按菜单分组。
- Edit 菜单直接调用 `Undo/Redo` 等高层接口。
- View 菜单修改 UI 状态（如 `showTimeline` 布尔值）。

### 3. commands 目录（命令与操作）

你已有 `src/commands/cmd_New_Projrct.cpp`，建议建立统一命令体系：

- **基础接口**
  - `ICommand`：用于支持 Undo/Redo 的命令（如像素绘制）。
  - 对于菜单命令（新建工程、打开工程），可以不进入 Undo 栈，只需要一个 `IAppCommand` 或简单函数调用即可。
- **建议命令分类**
  - **项目级命令**
    - `cmd_New_Project`：清空当前项目，创建新 Project，重置时间线。
    - `cmd_Open_Project`：弹文件对话框（或调用平台层），加载 Project。
    - `cmd_Save_Project` / `cmd_Save_Project_As`：序列化项目到磁盘。
  - **动画/帧命令**
    - `cmd_Add_Frame`, `cmd_Delete_Frame`, `cmd_Duplicate_Frame`, `cmd_Reorder_Frame` 等。
  - **绘图命令（进入 Undo 栈）**
    - `cmd_Draw_Pixels`（一个笔画或填充操作），内部记录像素差分。

### 4. windows 目录（ImGui 窗口封装）

`src/windows/` 适合放各种 UI 面板的封装代码：

- 建议文件：
  - `Window_Canvas.*`：实现画布展示与交互。
  - `Window_ToolPanel.*`：左侧工具栏。
  - `Window_Timeline.*`：底部时间线。
  - `Window_Properties.*`：右侧属性/颜色面板。
  - `Window_StatusBar.*`：底部状态栏（可和 Timeline 合并，也可分开）。
- 每个 `Window_*` 提供一个类似 `Draw(AppContext&)` 的入口函数，由 `main.cpp` 或 `App` 统一调用。

### 5. 与核心模块的连接方式

- `AppContext` / `EditorState`：
  - 包含：
    - `Project` 对象。
    - 当前动画索引、当前帧索引。
    - 当前工具、当前颜色、当前缩放与平移。
    - `CommandStack`（Undo/Redo）。
  - 由 UI 窗口读写其字段，实现状态共享。
- 渲染器 `GLRenderer`：
  - 提供：
    - `UploadCanvasTexture(PixelCanvas&)`
    - `DrawCanvasTexture(...)`
    - `GenerateFrameThumbnail(...)`
  - Canvas 窗口负责告知它何时需要更新纹理。

### 6. 里程碑下的具体实现顺序（结合现有结构）

- **M0**
  - 在 `main.cpp` 中完成 SDL3 + ImGui 初始化。
  - 添加一个简单 `Window_Demo` 或 `Window_Hello`，验证 UI 渲染。
- **M1**
  - 引入 `Project` + `PixelCanvas` 基础结构。
  - 在 `Window_Canvas` 中完成画布纹理显示与基本绘制（Brush/Eraser）。
  - 添加 `Window_ToolPanel` 与 `Window_Properties`，至少支持当前颜色和画笔大小。
  - `Menu_File` 中实现 `New/Save/Open`（即便先只用简单文件路径）。
- **M2**
  - 实现 `Animation` + `Frame` 数据结构。
  - 实现 `Window_Timeline` 与帧操作命令。
  - 在 `AppContext` 中加入播放状态与时间推进逻辑。
- **M3**
  - 完成 `ProjectSerializer` + PNG 导出 + SpriteSheet 导出。
  - 将菜单命令真正接入 IO 模块。
- **M4**
  - 按前文“扩展与打磨”中列出的功能逐项增强。
